Vagrant.configure("2") do |config|
    # Base box
    config.vm.box = "ubuntu/focal64"
    config.vm.hostname = "docker-vm"

    # Sync current project folder on host into VM at /home/vagrant/code
    # (host '.' means the folder where this Vagrantfile lives)
    config.vm.synced_folder ".", "/home/vagrant/code", owner: "vagrant", group: "vagrant"

    # Resources: 1 GB RAM
    config.vm.provider "virtualbox" do |vb|
        vb.memory = "1024"
        vb.cpus = 2
    end

    config.vm.network "forwarded_port", guest: 8500, host: 8500, auto_correct: true # consul
    config.vm.provision "shell", inline: <<-SHELL
        set -e
        export DEBIAN_FRONTEND=noninteractive

        apt-get update -y
        apt-get install -y apt-transport-https ca-certificates curl gnupg-agent software-properties-common

        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
        add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"

        apt-get update -y
        apt-get install -y docker-ce docker-ce-cli containerd.io

        # Add vagrant user to docker group so 'vagrant' can run docker without sudo
        usermod -aG docker vagrant

        systemctl enable docker
        systemctl restart docker
        sudo -u vagrant -H bash -c "curl -s https://raw.githubusercontent.com/canha/golang-tools-install-script/master/goinstall.sh | bash"
        sudo -u vagrant -H bash -c "curl https://raw.githubusercontent.com/jesseduffield/lazydocker/master/scripts/install_update_linux.sh | bash"
        docker compose up -d
    SHELL
end